<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Add a vector tile source</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>

var map = new mapboxgl.Map({
  container: 'map',
  style: 'https://tokyo-metropolitan-gov.github.io/tokyo-vector-tile/style.json',
  zoom: 16,
  center: [139.69167, 35.689444],
  antialias: false
});
let colorV2 = [
      'step',
      ['get', 'max'],
      '#FFE200',
      20, '#D4DB0C',
      30, '#AAD418',
      40, '#55BA2C',
      50, '#00A040',
      60, '#008C38',
      70, '#017730',
      80, '#016328'
]

map.on('load', function() {
  map.addLayer({
    'id': 'heatmap',
    'type': 'fill',
    'source': {
      'type': 'vector',
      'tiles': [
        'http://localhost:3000/tiles/20200305/corona_heatmap/hourly/8/{z}/{x}/{y}.pbf'
      ],
      'minzoom': 8,
      'maxzoom': 11,
      'bounds': [
        139.673264,
        35.673288,
        139.745141,
        35.729915
      ]    },
    'source-layer': 'dfi-place-heatmap-population',
    'paint': {
    'fill-color': [
'interpolate',
['linear'],
['get', 'max'],
0,
'blue',
20000,
'royalblue',
50000,
'cyan',
100000,
'lime',
150000,
'yellow',
200000,
'red'
],
    'fill-opacity': 0.5,
    'fill-outline-color': '#ffffff'
  }
  });
});
let popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});
map.on("mousemove", "heatmap", function(e) {

map.getCanvas().style.cursor = 'pointer';

popup.setLngLat(e.lngLat)
  .setHTML(
    "<div>" + Math.round(e.features[0].properties.max) + " äºº</div>")
  .addTo(map);

});
map.on("mouseleave", "heatmap", function() {
map.getCanvas().style.cursor = '';
popup.remove();
});
map.on('moveend', function() {
var features = map.queryRenderedFeatures({ layers: ['heatmap'] });
var s = 0;
features.forEach(function(d) {
  s += d.properties.max
});
console.log([s, features.length]);
});
</script>

</body>
</html>
